<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>学习</title>
  </head>
  <style type="text/css">
    * {
    }
  </style>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <body>
    <div class="d3Chart"></div>
  </body>
  <script type="text/javascript">
    /**
     * 未完成
     *
     * */

    // 画布
    const width = 700
    const height = 500
    const margin = 20
    const svg = d3
      .select('.d3Chart')
      .append('svg')
      .attr('width', width)
      .attr('height', height)
      .style('background-color', '#1a3055')
    // 图
    const chart = svg.append('g').attr('transform', `translate(${2 * margin}, ${2 * margin})`)

    const duration = 500
    // 模拟数据
    const numlength = 15
    let id = 0
    const dataArr = []
    for (let i = 0; i < numlength; i++) {
      dataArr.push({
        id: ++id,
        value: Math.round(Math.random() * 100)
      })
    }

    console.log('🚀 ~ file: 平移柱状图.html ~ line 41 ~ dataArr', dataArr)

    // 比例尺
    const xScale = d3
      .scaleBand()
      .range([0, 600])
      .domain(dataArr.map((d) => d.id))
      .padding(0.4)
    const yScale = d3.scaleLinear().range([400, 0]).domain([0, 100])

    const colorScale = d3.scaleOrdinal(d3.quantize(d3.interpolateRainbow, dataArr.length + 1))

    // 坐标轴
    // X
    chart.append('g').attr('transform', 'translate(15, 400)').call(d3.axisBottom(xScale))
    // Y
    const makeYlines = () =>
      d3
        .axisLeft()
        .scale(yScale)
        // .tickSize(-400)
        .tickFormat((d) => {
          return d + '%'
        })
    chart.append('g').attr('transform', 'translate(15, 0)').call(makeYlines())

    d3.selectAll('.d3Chart text').style('fill', '#fff')
    d3.selectAll('.d3Chart line').style('stroke', '#fff')
    d3.selectAll('.d3Chart path').style('stroke', '#fff')

    function render(data) {
      // 柱状
      const barG = chart
        .append('g')
        .selectAll()
        .data(data, function (d) {
          return d.id
        })

      const barGEnter = barG.enter().append('g')
      barGEnter
        .append('rect')
        .style('fill', '#ffffff')
        .attr('x', (g, i) => xScale(g.id) + xScale.bandwidth() / 2 + 5)
        .attr('y', (g) => yScale(g.value))
        .attr('width', xScale.bandwidth)
        .attr('height', (g) => 400 - yScale(g.value))
      barGEnter
        .append('text')
        .style('font-size', '14px')
        .style('fill', '#fff')
        .attr('x', (g, i) => xScale(g.id) + xScale.bandwidth() / 2 + 2)
        .attr('y', (g) => yScale(g.value) - 10)
        .text((g) => `${g.value}%`)
    }

    render(dataArr)

    // var int = setInterval(function () {
    //   dataArr.shift()
    //   dataArr.push({
    //     id: ++id,
    //     value: Math.round(Math.random() * 100)
    //   })
    //   render(dataArr)
    // }, 2000)
  </script>
</html>
